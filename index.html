<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Allowance Tracker</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <link rel="icon" href="icon-192.png" sizes="192x192">

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; color:#333; }
    h1 { font-size: 1.4em; margin-bottom: 0.5em; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    td, th { border: 1px solid #ddd; padding: 8px; text-align:center; }
    .amount { font-variant-numeric: tabular-nums; }
    .muted { color: #666; }
    .over { color: red; }
    .under { color: green; }
    .zero { color: #333; }
    .progress { background:#eee; height:10px; border-radius:5px; overflow:hidden; }
    .progress > div { background:#4CAF50; height:100%; }
    .progress.red > div { background:#f44336; }
    .progress.green > div { background:#4CAF50; }
    .row { display:flex; gap:6px; align-items:center; }
    .pill { background:#4CAF50; color:white; font-size:0.7em; padding:2px 6px; border-radius:10px; }
    .secondary { background:#eee; }
    button { padding: 4px 8px; cursor:pointer; border:none; border-radius:4px; }
    input[type="number"] { padding:4px; }

    /* Switch styling */
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input {display:none;}
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #f44336; /* red for off */
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #4CAF50; }
    input:checked + .slider:before { transform: translateX(26px); }
  </style>
</head>
<body>
  <h1>Allowance Tracker</h1>

  <div id="weekRangeEl"></div>

  <!-- Rolling mode toggle -->
  <div style="margin:10px 0;">
    <label>Rolling Mode:
      <label class="switch">
        <input type="checkbox" id="rollingToggle" checked>
        <span class="slider"></span>
      </label>
    </label>
  </div>

  <div>Total Spent: <span id="totalSpent"></span></div>
  <div>Remaining: <span id="remaining"></span></div>
  <div>Days Remaining: <span id="remainingDays"></span></div>
  <div>Suggested per-day: <span id="suggested"></span></div>
  <div id="moneySavedBox" style="margin-top:10px;font-weight:bold;"></div>

  <div style="margin-top:10px;background:#ddd;height:20px;border-radius:10px;overflow:hidden;">
    <div id="overallBar" style="height:100%;background:#4CAF50;width:0%;"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Day</th>
        <th>Daily</th>
        <th>Spent</th>
        <th>Remaining (Day)</th>
        <th>Over/Under</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
const fmt = new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'});
const dayNames = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
const weekRangeEl = document.getElementById('weekRangeEl');
const totalSpentEl = document.getElementById('totalSpent');
const remainingEl = document.getElementById('remaining');
const remainingDaysEl = document.getElementById('remainingDays');
const suggestedEl = document.getElementById('suggested');
const tbody = document.getElementById('tbody');
const overallBar = document.getElementById('overallBar');

let state = JSON.parse(localStorage.getItem('state')||'{"allowance":140,"spent":[0,0,0,0,0,0,0]}');
function saveState(s){ localStorage.setItem('state',JSON.stringify(s)); }

function startOfWeekMonday(d=new Date()){ const n=new Date(d); const day=(n.getDay()+6)%7; n.setDate(n.getDate()-day); return n; }
function endOfWeekSunday(d=new Date()){ const n=startOfWeekMonday(d); n.setDate(n.getDate()+6); return n; }
function dayIndexMondayFirst(d){ return (d.getDay()+6)%7; }
function clamp(v,min,max){ return Math.min(Math.max(v,min),max); }

function addSpend(i, amount){
  if(!isFinite(amount) || amount <= 0) return;
  const next = [...state.spent];
  next[i] = +(next[i] + amount).toFixed(2);
  state.spent = next;
  saveState(state);
  render();
}
function clearSpend(i){
  state.spent[i] = 0;
  saveState(state);
  render();
}

function render(){
  const mon = startOfWeekMonday();
  const sun = endOfWeekSunday();
  const fmtDate = (d)=> d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
  weekRangeEl.textContent = `${fmtDate(mon)} â€“ ${fmtDate(sun)}`;

  const totalSpent = state.spent.reduce((a,b)=>a+b,0);
  const remaining = +(state.allowance - totalSpent).toFixed(2);
  const todayIdx = dayIndexMondayFirst(new Date());
  const daysLeft = clamp(7 - todayIdx,0,7);
  const rollingMode = document.getElementById('rollingToggle').checked;

  let daily = state.allowance/7;
  let suggested = daysLeft>0 ? remaining/daysLeft : 0;

  totalSpentEl.textContent = fmt.format(totalSpent);
  remainingEl.textContent = fmt.format(remaining);
  remainingDaysEl.textContent = String(daysLeft);
  suggestedEl.textContent = fmt.format(Math.max(0,suggested));

  const overallPct = state.allowance>0 ? clamp((totalSpent/state.allowance)*100,0,100) : 0;
  overallBar.style.width = overallPct + '%';

  tbody.innerHTML='';
  dayNames.forEach((name,i)=>{
    const tr=document.createElement('tr');
    const spent = state.spent[i]||0;
    let dayBudget = state.allowance/7;

    if(rollingMode){
      // redistribute leftover dynamically
      const daysRemaining = 7 - i;
      const spentSoFar = state.spent.slice(0,i+1).reduce((a,b)=>a+b,0);
      const left = state.allowance - spentSoFar;
      dayBudget = left/daysRemaining;
    }

    const remainingDay = +(dayBudget - spent).toFixed(2);
    const overUnder = +(spent - dayBudget).toFixed(2);
    const pct = dayBudget>0 ? clamp((spent/dayBudget)*100,0,200):0;
    const bar=document.createElement('div');
    bar.className='progress ' + (overUnder>0?'red':overUnder<0?'green':'');
    bar.innerHTML=`<div style="width:${clamp(pct,0,100)}%"></div>`;
    tr.innerHTML=`
      <td class="muted">${name}${i===todayIdx ? ' <span class="pill">today</span>':''}</td>
      <td class="amount">${fmt.format(dayBudget)}</td>
      <td class="amount">${fmt.format(spent)}</td>
      <td class="amount ${remainingDay<0?'over':remainingDay>0?'under':'zero'}">${fmt.format(remainingDay)}</td>
      <td class="amount ${overUnder>0?'over':overUnder<0?'under':'zero'}">${overUnder>0?'+':''}${fmt.format(overUnder)}</td>
      <td>
        <div class="row">
          <input type="number" min="0" step="0.01" placeholder="0.00" id="add-${i}" style="width:110px" />
          <button data-i="${i}" class="addBtn">Add</button>
          <button data-i="${i}" class="secondary clearBtn">Clear</button>
        </div>
        <div style="margin-top:8px">${bar.outerHTML}</div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Bind buttons
  document.querySelectorAll('.addBtn').forEach(btn=>{
    btn.onclick=()=>{
      const i=+btn.getAttribute('data-i');
      const inp=document.getElementById(`add-${i}`);
      const val=parseFloat(inp.value);
      addSpend(i,isFinite(val)?val:0);
      inp.value='';
      inp.focus();
    };
  });
  document.querySelectorAll('.clearBtn').forEach(btn=>{
    btn.onclick=()=>{ const i=+btn.getAttribute('data-i'); clearSpend(i); };
  });

  // Overspend highlight on overall bar
  overall.classList.remove('red','green');
  if(remaining<0) overall.classList.add('red');
  else overall.classList.add('green');

  // Money saved box when rolling is OFF
  const moneySavedBox=document.getElementById('moneySavedBox');
  if(!rollingMode){
    if(remaining===0){
      moneySavedBox.textContent='None';
    } else if(remaining<0){
      moneySavedBox.textContent='You went over by: '+fmt.format(Math.abs(remaining));
    } else {
      moneySavedBox.textContent='You saved '+fmt.format(remaining);
    }
  } else {
    moneySavedBox.textContent='';
  }
}

render();
document.getElementById('rollingToggle').addEventListener('change',()=>{ render(); });
</script>
</body>
</html>
